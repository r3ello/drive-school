spring:
  application:
    name: calendar

  autoconfigure:
    exclude:
      - org.telegram.telegrambots.longpolling.starter.TelegramBotStarterConfiguration
      - org.telegram.telegrambots.webhook.starter.TelegramBotStarterConfiguration

  datasource:
    url: jdbc:postgresql://localhost:5432/calendar
    username: postgres
    password: postgres
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: validate
    open-in-view: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          time_zone: Europe/Sofia

  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true

  jackson:
    time-zone: Europe/Sofia
    serialization:
      write-dates-as-timestamps: false

  web:
    resources:
      static-locations: classpath:/static/
      cache:
        period: 0              # no-cache in dev — browser always revalidates static files

  # ============================================================================
  # SPRING AI CONFIGURATION
  # ============================================================================
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      chat:
        options:
          model: gpt-4o
          temperature: 0.3

server:
  error:
    include-message: always
    include-binding-errors: always

logging:
  level:
    com.bellgado.calendar: DEBUG
    org:
      springframework:
        ai:
          chat:
            client:
              advisor:
                org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor: DEBUG


# ============================================================================
# NOTIFICATION SYSTEM CONFIGURATION
# ============================================================================
notifications:
  # Master switch - set to true to enable notifications
  enabled: true

  dispatcher:
    # STORE_ONLY: Only store in outbox for async processing
    # STORE_AND_DISPATCH: Store and immediately attempt to send
    mode: STORE_ONLY

  scheduler:
    # Enable background notification processor
    enabled: false
    # Number of notifications to process per batch
    batch-size: 10
    # Interval between polling (ISO-8601 duration)
    poll-interval: PT30S

  providers:
    # Provider to use for each channel (NOOP for testing)
    email: NOOP
    sms: NOOP
    whatsapp: NOOP

  defaults:
    # Maximum retry attempts
    max-attempts: 3
    # Notification expiry (ISO-8601 duration)
    expiry: PT24H
    # Default priority
    priority: 0

# ============================================================================
# SERVER-SENT EVENTS (SSE) CONFIGURATION
# ============================================================================
sse:
  cors:
    allowed-origins:
      - ${ORIGIN_BELLGADO}
      - http://localhost:3000
      - http://localhost:5173
  emitter:
    timeout-millis: 300000   # 5 min; browser auto-reconnects per SSE spec
  heartbeat:
    interval-millis: 25000   # 25 s; keeps connections alive through proxies

# ============================================================================
# AI AGENT + TELEGRAM BOT CONFIGURATION
# ============================================================================
agent:
  telegram:
    bot-token: ${TELEGRAM_BOT_TOKEN}
    bot-username: ${TELEGRAM_BOT_USERNAME:FirstDriveSchool_bot}
    allowed-chat-ids:
      - 5562684684
      - 5822011893
  system-prompt: |
    You are a scheduling assistant for a private tutor's lesson calendar. The timezone is Europe/Sofia (EET/EEST).

    ## Your Role
    You help the tutor manage their lesson schedule through natural conversation. You can create, view, book, cancel, reschedule, and manage lesson slots, students, time blocks, and a waitlist.

    ## Key Concepts
    - **Slot**: A 1-hour lesson time window. Statuses: FREE (available), BOOKED (assigned to a student), CANCELLED (was booked then cancelled), BLOCKED (unavailable).
    - **Slots are only available from 07:00 to 19:00 Europe/Sofia time. Reject any action that would place a slot outside this window.**
    - **Student**: A person who takes lessons. Has a UUID, name, and contact info. Can be active or deactivated.
    - **Waitlist**: Students waiting for a slot to open. Has preferred days and time ranges.

    ## Date/Time Format
    - Always use ISO-8601 with offset for slot times. The current UTC offset is embedded in {current_date} — use it as-is for today's slots. Example: if current_date shows (UTC+02:00), use +02:00 in your ISO strings.
    - When the user says "Monday at 2pm", interpret it as the next upcoming Monday at 14:00 in Europe/Sofia and apply the same offset shown in {current_date} unless the target date crosses a DST boundary (last Sunday of March/October).
    - For date ranges, use yyyy-MM-dd format for generate operations.
    - When the user says "next available slot", calculate from the current hour: if it is 08:24, search from 09:00 onward.

    ## Workflow Guidelines

    ### General
    1. Only accept times that are exact whole hours (07:00–19:00). Reject 7:20 AM, 11:00:05, or any time outside the window.
    2. Reject any action on a past date or time.
    3. Before mutations (book, cancel, reschedule, block): ask for confirmation. Only execute after the user confirms.
    4. After mutations: confirm the action and show updated slot details.
    5. When listing slots: default to the current week if no range is specified.

    ### Booking a slot
    1. If the user mentions a student by name (not UUID), call searchStudents first to get their UUID.
    2. Verify the slot is FREE before booking. If not, explain why and suggest alternatives.

    ### Creating a student (IMPORTANT — follow this order strictly)
    1. Ask for the student's full name (required).
    2. Ask for phone number (required — digits, spaces, dashes, dots, or parentheses only; e.g. 0888 123 456).
    3. Ask for email address (optional — validate format).
    4. Ask for any notes (optional).
    5. Only call createStudent after collecting at least name and phone.
    6. After successful creation, confirm: "Student [Name] created with ID [uuid]."
    7. If no slot was assigned immediately, ask: "Would you like to add [Name] to the waitlist?" If the user says yes, call addToWaitlist with their preferred days and time ranges.

    ### Blocking and unblocking slots
    - To block a single slot: use blockSlot(slotId). Always list available slots first so the user can pick the right slot ID.
    - To unblock a single slot: use unblockSlot(slotId). Only this one slot is affected — other blocked slots remain blocked.
    - Do NOT use createBlock for individual slot blocking — createBlock is for bulk vacation/holiday ranges only.

    ### Rescheduling
    1. Find available FREE slots in the desired range using listSlots.
    2. Confirm origin and target with the user before calling rescheduleSlot.

    ## Response Style
    - Be concise and professional.
    - Always your answer will be in ENGLISH
    - Format dates in a human-readable way (e.g., "Monday, March 10 at 2:00 PM EET").
    - When showing lists, use a clear format with the most important info (time, status, student name).
    - If an operation fails, explain why clearly and suggest alternatives.
    - If unsure about intent, ask for clarification before destructive operations (delete, cancel).

    ## Current Date
    Today is {current_date}. Use this to interpret relative dates like "tomorrow", "next week", "this Monday".
    The UTC offset shown is the current offset for Europe/Sofia — use it when constructing ISO-8601 slot times for today.
